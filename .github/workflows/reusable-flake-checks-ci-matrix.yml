name: 'ci-matrix'

on:
  # Allow this workflow to be reused by other workflows:
  workflow_call:
    inputs:
      runner:
        description: 'JSON-encoded list of runner labels'
        default: '["self-hosted"]'
        required: false
        type: string
      run-cachix-deploy:
        description: 'Deploy to cachix'
        type: 'boolean'
        default: false
        required: false
    secrets:
      CACHIX_AUTH_TOKEN:
        description: 'Cachix auth token'
        required: true
      CACHIX_ACTIVATE_TOKEN:
        description: 'Cachix activate token'
        required: false
      NIX_GITHUB_TOKEN:
        description: GitHub token to add as access-token in nix.conf
        required: false
      NIX_GITLAB_TOKEN:
        description: GitLab token to add as access-token in nix.conf
        required: false

jobs:
  compute-mcl-ref:
    name: Compute MCL Reference
    runs-on: ${{ fromJSON(inputs.runner) }}
    outputs:
      workflow_sha: ${{ steps.compute.outputs.workflow_sha }}
      mcl_flake_cmd: ${{ steps.compute.outputs.mcl_flake_cmd }}
    steps:
      - name: Compute reusable workflow SHA and set mcl nix run command
        id: compute
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -x
          if [[ "${{ github.repository }}" == "metacraft-labs/nixos-modules" ]]; then
            # Testing in the reusable workflow's own repo
            WORKFLOW_SHA="${{ github.sha }}"
          else
            # Try to get from referenced_workflows
            WORKFLOW_SHA=$(gh api /repos/${{ github.repository }}/actions/runs/${{ github.run_id }} \
              --jq '[.referenced_workflows[] | select(.path | contains("reusable-flake-checks-ci-matrix")) | .sha] | first' 2>/dev/null || true)

            if [[ -z "$WORKFLOW_SHA" ]]; then
              # Fallback to main
              WORKFLOW_SHA="main"
            fi
          fi
          echo "workflow_sha=$WORKFLOW_SHA" >> "$GITHUB_OUTPUT"
          echo "mcl_flake_cmd=nix run --accept-flake-config github:metacraft-labs/nixos-modules/${WORKFLOW_SHA}#mcl" >> $GITHUB_OUTPUT

  post-initial-comment:
    runs-on: ${{ fromJSON(inputs.runner) }}
    steps:
      - name: 'Post initial package status comment'
        uses: marocchino/sticky-pull-request-comment@v2.9.4
        with:
          recreate: true
          message: |
            Thanks for your Pull Request!

            This comment will be updated automatically with the status of each package.

  shard-matrix:
    needs: compute-mcl-ref
    runs-on: ${{ fromJSON(inputs.runner) }}
    steps:
      - name: Setup Nix
        uses: metacraft-labs/nixos-modules/.github/setup-nix@main
        with: &setup-nix-no-push
          push-to-cache: false
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}
          nix-github-token: ${{ secrets.NIX_GITHUB_TOKEN }}
          nix-gitlab-token: ${{ secrets.NIX_GITLAB_TOKEN }}
          nix-gitlab-domain: ${{ vars.NIX_GITLAB_DOMAIN }}

      - uses: actions/checkout@v6

      - name: Generate Shard Matrix
        id: generate-matrix
        env:
          CACHIX_CACHE: ${{ vars.CACHIX_CACHE }}
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
        run: ${{ needs.compute-mcl-ref.outputs.mcl_flake_cmd }} shard-matrix

      - name: Post CI matrix comment
        if: steps.generate-matrix.outputs.full_matrix
        uses: marocchino/sticky-pull-request-comment@v2.9.4
        with:
          recreate: true
          path: comment.md

    outputs:
      eval_matrix: ${{ steps.generate-matrix.outputs.eval_matrix }}
      build_matrix: ${{ steps.generate-matrix.outputs.build_matrix }}
      full_matrix: ${{ steps.generate-matrix.outputs.full_matrix }}

  eval-matrix:
    needs: [compute-mcl-ref, shard-matrix]
    runs-on: ${{ fromJSON(inputs.runner) }}
    if: needs.shard-matrix.outputs.eval_matrix
    strategy:
      matrix: ${{fromJSON(needs.shard-matrix.outputs.eval_matrix)}}
    steps:
      - name: Setup Nix
        uses: metacraft-labs/nixos-modules/.github/setup-nix@main
        with: *setup-nix-no-push

      - uses: actions/checkout@v6

      - name: Generate CI Matrix
        id: generate-matrix
        shell: bash
        env:
          CACHIX_CACHE: ${{ vars.CACHIX_CACHE }}
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
        run: |
          ${{ needs.compute-mcl-ref.outputs.mcl_flake_cmd }} -- ci-matrix \
            --flake-attribute-path "${{ matrix.flakeAttrPath }}" \
            --is-initial

      - uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.filename }}
          path: matrix-pre.json
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}

  merge-matrices:
    runs-on: ${{ fromJSON(inputs.runner) }}
    needs: [compute-mcl-ref, shard-matrix, eval-matrix]
    name: Merge matrices
    outputs:
      build_matrix: ${{ steps.merge.outputs.build_matrix }}
      full_matrix: ${{ steps.merge.outputs.full_matrix }}
    if: needs.shard-matrix.outputs.eval_matrix != '{"include":[]}' &&
      needs.eval-matrix.result == 'success'
    steps:
      - name: Setup Nix
        uses: metacraft-labs/nixos-modules/.github/setup-nix@main
        with: *setup-nix-no-push

      - uses: actions/download-artifact@v7
        if: needs.eval-matrix.result == 'success'

      - name: Merge matrices
        if: needs.eval-matrix.result == 'success'
        id: merge
        run: ${{ needs.compute-mcl-ref.outputs.mcl_flake_cmd }} merge-ci-matrices

      - name: Generate CI matrix comment
        env:
          IS_INITIAL: 'true'
          CACHIX_CACHE: ${{ vars.CACHIX_CACHE }}
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
          PRECALC_MATRIX: ${{ steps.merge.outputs.full_matrix }}
        run: ${{ needs.compute-mcl-ref.outputs.mcl_flake_cmd }} print-table

      - name: Post CI matrix comment
        uses: marocchino/sticky-pull-request-comment@v2.9.4
        with:
          recreate: true
          path: comment.md

  build:
    needs: [shard-matrix, merge-matrices]
    if: needs.shard-matrix.outputs.build_matrix ||
      needs.merge-matrices.outputs.build_matrix
    strategy:
      fail-fast: false
      matrix: >-
        ${{fromJSON(
          needs.merge-matrices.outputs.build_matrix ||
          needs.shard-matrix.outputs.build_matrix
        )}}

    name: ${{ matrix.name }} | ${{ matrix.system }}
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.allowedToFail }}

    steps:
      - uses: actions/checkout@v6

      - name: Setup Nix
        uses: metacraft-labs/nixos-modules/.github/setup-nix@main
        with:
          push-to-cache: true
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}
          nix-github-token: ${{ secrets.NIX_GITHUB_TOKEN }}
          nix-gitlab-token: ${{ secrets.NIX_GITLAB_TOKEN }}
          nix-gitlab-domain: ${{ vars.NIX_GITLAB_DOMAIN }}

      - name: Build ${{ matrix.name }}
        run: |
          nix build -L --no-link --keep-going --show-trace \
            '.#${{ matrix.attrPath }}'

      # TODO: replace with `attic`
      - name: Push to Cachix ${{ matrix.name }}
        run: |
          cachix push ${{ vars.CACHIX_CACHE }} ${{ matrix.output }}

  results:
    runs-on: ${{ fromJSON(inputs.runner) }}
    name: Final Results
    needs: [compute-mcl-ref, build, shard-matrix, merge-matrices]
    if: always()
    steps:
      - name: Setup Nix
        uses: metacraft-labs/nixos-modules/.github/setup-nix@main
        with: *setup-nix-no-push

      - name: Print CI Matrix
        env:
          IS_INITIAL: 'false'
          CACHIX_CACHE: ${{ vars.CACHIX_CACHE }}
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
          PRECALC_MATRIX: ${{
            needs.merge-matrices.result == 'success' &&
            needs.merge-matrices.outputs.full_matrix ||
            needs.shard-matrix.outputs.full_matrix
            }}
        run: ${{ needs.compute-mcl-ref.outputs.mcl_flake_cmd }} print-table

      - name: Update GitHub Comment
        uses: marocchino/sticky-pull-request-comment@v2.9.4
        with:
          recreate: true
          path: comment.md

      - run: exit 1
        if: >-
          (
            (
              needs.merge-matrices.result == 'success' &&
              needs.merge-matrices.outputs.build_matrix != '{"include":[]}'
            ) ||
              needs.shard-matrix.outputs.build_matrix != '{"include":[]}'
          ) && (
            contains(needs.*.result, 'failure') ||
            contains(needs.*.result, 'cancelled')
          )

      - uses: actions/checkout@v6
        if: inputs.run-cachix-deploy

      - name: Deploy
        if: inputs.run-cachix-deploy
        env:
          CACHIX_CACHE: ${{ vars.CACHIX_CACHE }}
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
          CACHIX_ACTIVATE_TOKEN: '${{ secrets.CACHIX_ACTIVATE_TOKEN }}'
        run: ${{ needs.compute-mcl-ref.outputs.mcl_flake_cmd }} deploy-spec
