name: 'CI'

on:
  # Allow this workflow to be reused by other workflows:
  workflow_call:
    inputs:
      runner:
        description: 'JSON-encoded list of runner labels'
        default: '["self-hosted"]'
        required: false
        type: string
      run-cachix-deploy:
        description: 'Deploy to cachix'
        type: 'boolean'
        default: false
        required: false
    secrets:
      CACHIX_AUTH_TOKEN:
        description: 'Cachix auth token'
        required: true
      CACHIX_ACTIVATE_TOKEN:
        description: 'Cachix activate token'
        required: false
      NIX_GITHUB_TOKEN:
        description: GitHub token to add as access-token in nix.conf
        required: false
      NIX_GITLAB_TOKEN:
        description: GitLab token to add as access-token in nix.conf
        required: false

jobs:
  post-initial-comment:
    runs-on: ${{ fromJSON(inputs.runner) }}
    steps:
      - name: 'Post initial package status comment'
        uses: marocchino/sticky-pull-request-comment@v2.9.4
        with:
          recreate: true
          message: |
            Thanks for your Pull Request!

            This comment will be updated automatically with the status of each package.

  shard-matrix:
    name: Shard Matrix
    runs-on: ${{ fromJSON(inputs.runner) }}
    steps:
      - name: Setup Nix
        uses: metacraft-labs/nixos-modules/.github/setup-nix@main
        with:
          push-to-cache: false
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}
          nix-github-token: ${{ secrets.NIX_GITHUB_TOKEN }}
          nix-gitlab-token: ${{ secrets.NIX_GITLAB_TOKEN }}
          nix-gitlab-domain: ${{ vars.NIX_GITLAB_DOMAIN }}

      - uses: actions/checkout@v6

      - name: Generate Shard Matrix
        id: generate-matrix
        env:
          CACHIX_CACHE: ${{ vars.CACHIX_CACHE }}
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
          MCL_BRANCH: ${{ github.repository == 'metacraft-labs/nixos-modules' && github.sha || 'main' }}
        run: |
          nix run --accept-flake-config github:metacraft-labs/nixos-modules/${{ env.MCL_BRANCH }}#mcl shard-matrix

    outputs:
      eval_matrix: ${{ steps.generate-matrix.outputs.eval_matrix }}
      build_matrix: ${{ steps.generate-matrix.outputs.build_matrix }}
      full_matrix: ${{ steps.generate-matrix.outputs.full_matrix }}

  eval-matrix:
    needs: shard-matrix
    runs-on: ${{ fromJSON(inputs.runner) }}
    strategy:
      matrix: ${{fromJSON(needs.shard-matrix.outputs.eval_matrix)}}
    name: Generate Matrix ${{ matrix.flakeAttrPath }}
    if: needs.shard-matrix.outputs.eval_matrix != '{"include":[]}'
    steps:
      - name: Setup Nix
        uses: metacraft-labs/nixos-modules/.github/setup-nix@main
        with:
          push-to-cache: false
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}
          nix-github-token: ${{ secrets.NIX_GITHUB_TOKEN }}
          nix-gitlab-token: ${{ secrets.NIX_GITLAB_TOKEN }}
          nix-gitlab-domain: ${{ vars.NIX_GITLAB_DOMAIN }}

      - uses: actions/checkout@v6

      - name: Conditionally export `FLAKE_ATTR_PATH`
        run: |
          if [ "${{ matrix.flakeAttrPath }}" != '' ]; then
            echo "FLAKE_ATTR_PATH=${{ matrix.flakeAttrPath }}" >> $GITHUB_ENV
          fi

      - name: Generate CI Matrix
        id: generate-matrix
        shell: bash
        env:
          IS_INITIAL: 'true'
          CACHIX_CACHE: ${{ vars.CACHIX_CACHE }}
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
          MCL_BRANCH: ${{ github.repository == 'metacraft-labs/nixos-modules' && github.sha || 'main' }}
        run: nix run --accept-flake-config github:metacraft-labs/nixos-modules/${{ env.MCL_BRANCH }}#mcl ci-matrix

      - uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.filename }}
          path: matrix-pre.json
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}

  merge-matrices:
    runs-on: ${{ fromJSON(inputs.runner) }}
    needs: [shard-matrix, eval-matrix]
    name: Merge matrices
    outputs:
      build_matrix: ${{ steps.merge.outputs.build_matrix }}
      full_matrix: ${{ steps.merge.outputs.full_matrix }}
    if: needs.shard-matrix.outputs.eval_matrix != '{"include":[]}' && needs.eval-matrix.result == 'success'
    steps:
      - name: Install Nix
        uses: metacraft-labs/nixos-modules/.github/install-nix@main
        with:
          push-to-cache: false
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}
          nix-github-token: ${{ secrets.NIX_GITHUB_TOKEN }}
          nix-gitlab-token: ${{ secrets.NIX_GITLAB_TOKEN }}
          nix-gitlab-domain: ${{ vars.NIX_GITLAB_DOMAIN }}

      - uses: actions/download-artifact@v7
        if: needs.eval-matrix.result == 'success'

      - name: Merge matrices
        if: needs.eval-matrix.result == 'success'
        id: merge
        env:
          MCL_BRANCH: ${{ github.repository == 'metacraft-labs/nixos-modules' && github.sha || 'main' }}
        run: nix run --accept-flake-config github:metacraft-labs/nixos-modules/${{ env.MCL_BRANCH }}#mcl merge-ci-matrices

      - name: Print CI Matrix
        id: print-matrix
        shell: bash
        env:
          IS_INITIAL: 'true'
          CACHIX_CACHE: ${{ vars.CACHIX_CACHE }}
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
          PRECALC_MATRIX: ${{ steps.merge.outputs.full_matrix }}
          MCL_BRANCH: ${{ github.repository == 'metacraft-labs/nixos-modules' && github.sha || 'main' }}
        run: nix run --accept-flake-config github:metacraft-labs/nixos-modules/${{ env.MCL_BRANCH }}#mcl print-table

      - name: Update GitHub Comment
        uses: marocchino/sticky-pull-request-comment@v2.9.0
        with:
          recreate: true
          path: comment.md

  build:
    needs: [shard-matrix, merge-matrices]
    if: always()
    strategy:
      fail-fast: false
      matrix: ${{fromJSON( (needs.merge-matrices.result == 'success' && needs.merge-matrices.outputs.build_matrix) || needs.shard-matrix.outputs.build_matrix )}}

    name: ${{ matrix.name }} | ${{ matrix.system }}
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.allowedToFail }}

    steps:
      - uses: actions/checkout@v6

      - name: Setup Nix
        uses: metacraft-labs/nixos-modules/.github/setup-nix@main
        with:
          push-to-cache: true
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}
          nix-github-token: ${{ secrets.NIX_GITHUB_TOKEN }}
          nix-gitlab-token: ${{ secrets.NIX_GITLAB_TOKEN }}
          nix-gitlab-domain: ${{ vars.NIX_GITLAB_DOMAIN }}

      - name: Build ${{ matrix.name }}
        run: |
          nix build -L --no-link --keep-going --show-trace \
            '.#${{ matrix.attrPath }}'

      # TODO: replace with `attic`
      - name: Push to Cachix ${{ matrix.name }}
        run: |
          cachix push ${{ vars.CACHIX_CACHE }} ${{ matrix.output }}

  results:
    runs-on: ${{ fromJSON(inputs.runner) }}
    name: Final Results
    needs: [build, shard-matrix, merge-matrices]
    if: always()
    steps:
      - name: Setup Nix
        uses: metacraft-labs/nixos-modules/.github/setup-nix@main
        with:
          push-to-cache: false
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}
          nix-github-token: ${{ secrets.NIX_GITHUB_TOKEN }}
          nix-gitlab-token: ${{ secrets.NIX_GITLAB_TOKEN }}
          nix-gitlab-domain: ${{ vars.NIX_GITLAB_DOMAIN }}

      - name: Print CI Matrix
        id: print-matrix
        shell: bash
        env:
          IS_INITIAL: 'false'
          CACHIX_CACHE: ${{ vars.CACHIX_CACHE }}
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
          PRECALC_MATRIX: ${{ needs.merge-matrices.result == 'success' && needs.merge-matrices.outputs.full_matrix || needs.shard-matrix.outputs.full_matrix }}
          MCL_BRANCH: ${{ github.repository == 'metacraft-labs/nixos-modules' && github.sha || 'main' }}
        run: nix run --accept-flake-config github:metacraft-labs/nixos-modules/${{ env.MCL_BRANCH }}#mcl print-table

      - name: Update GitHub Comment
        uses: marocchino/sticky-pull-request-comment@v2.9.0
        with:
          recreate: true
          path: comment.md

      - run: exit 1
        if: >-
          (needs.merge-matrices.result == 'success' && needs.merge-matrices.outputs.build_matrix != '{"include":[]}' || needs.shard-matrix.outputs.build_matrix != '{"include":[]}')
          && (contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled'))

      - uses: actions/checkout@v6
        if: inputs.run-cachix-deploy

      - name: Deploy
        if: inputs.run-cachix-deploy
        env:
          CACHIX_CACHE: ${{ vars.CACHIX_CACHE }}
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
          CACHIX_ACTIVATE_TOKEN: '${{ secrets.CACHIX_ACTIVATE_TOKEN }}'
          MCL_BRANCH: ${{ github.repository == 'metacraft-labs/nixos-modules' && github.sha || 'main' }}
        run: nix run --accept-flake-config github:metacraft-labs/nixos-modules/${{ env.MCL_BRANCH }}#mcl deploy-spec
