# Copyright 2026 Schelling Point Labs Inc
# SPDX-License-Identifier: AGPL-3.0-only

# Unattended macOS Ventura Setup Assistant Configuration
#
# This YAML config automates the macOS Ventura (13.x) OOBE (Out-of-Box Experience)
# setup for creating reproducible VM images. Uses native YAML format for better
# validation and IDE support.
#
# Usage:
#   yaml-automation-runner --config macos-ventura.yml --vnc localhost:5900
#
# Prerequisites:
#   - macOS Ventura BaseSystem.img (from fetchMacOSBaseSystem)
#   - OpenCore bootloader configured
#   - InstallAssistant.pkg ISO mounted
#   - run_offline.sh ISO mounted at /Volumes/run_offline/
#
# Account credentials created:
#   - Username: admin
#   - Password: admin
#
# References:
#   - Schema: YAML-AUTOMATION-SCHEMA.md
#   - OSX-KVM: https://github.com/kholia/OSX-KVM

# Seconds to wait after VM boots before starting automation
# Ventura takes longer to boot than newer versions due to OpenCore initialization
boot_wait: 60

boot_commands:
  # ============================================
  # Stage 1: Initial Boot and Installer Setup
  # ============================================

  # Wait for the installer to reach the "Continue" button
  # This appears after the language selection animation completes
  - wait:
      text: 'Continue'
      timeout: 300

  - delay: 5

  # Open Terminal using keyboard shortcut (Shift+Cmd+T in Recovery)
  # This is needed to run the offline installation script
  - hotkey:
      modifiers: [shift, cmd]
      key: t

  - delay: 3

  # Wait for Terminal to open
  - wait:
      text: 'Terminal'
      timeout: 30

  - wait:
      text: '80x24'
      timeout: 10

  - delay: 2

  # Run the offline installation script that partitions the disk
  # This script is provided on the run_offline ISO mounted at /Volumes/run_offline/
  - type: 'sh /Volumes/run_offline/run_offline.sh'
  - key: enter
  - delay: 10

  # ============================================
  # Stage 2: Country/Region Selection
  # ============================================

  - wait:
      text: 'Select Your Country or Region'
      timeout: 120

  - delay: 2

  # Type to filter and select United States
  - type: 'united states'
  - delay: 1

  # Navigate to Continue button (Shift+Tab moves backwards through UI)
  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 3: Written and Spoken Languages
  # ============================================

  - wait:
      text: 'Written and Spoken Languages'
      timeout: 60

  - delay: 1

  # Skip customization, go directly to Continue
  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 4: Accessibility
  # ============================================

  - wait:
      text: 'Accessibility'
      timeout: 60

  - delay: 1

  # Skip accessibility setup
  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 5: Network Connection (Offline Mode)
  # ============================================

  - wait:
      text: 'How Do You Connect'
      timeout: 60

  - delay: 2

  # Click on "My computer does not connect to the internet" option
  # Coordinates based on NixThePlanet's working values for 1920x1080
  - click_at:
      x: 815
      y: 480

  - delay: 10

  # Click Continue button
  - click_at:
      x: 1330
      y: 820

  - delay: 3

  # ============================================
  # Stage 6: No Internet Confirmation
  # ============================================

  - wait:
      text: 'Your Mac isn'
      timeout: 30

  - delay: 2

  # Click Continue to proceed without internet
  - click_at:
      x: 1020
      y: 640

  - delay: 3

  # ============================================
  # Stage 7: Data & Privacy
  # ============================================

  - wait:
      text: 'Data & Privacy'
      timeout: 60

  - delay: 1

  # Continue past privacy notice
  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 8: Migration Assistant
  # ============================================

  - wait:
      text: 'Migration Assistant'
      timeout: 60

  - delay: 2

  # Navigate to "Not Now" option (third tab from current position)
  - key: tab
  - delay: 1
  - key: tab
  - delay: 1
  - key: tab
  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 9: Terms and Conditions
  # ============================================

  - wait:
      text: 'Terms and Conditions'
      timeout: 60

  - delay: 1

  # Navigate to Agree button
  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 2

  # ============================================
  # Stage 10: License Agreement Confirmation
  # ============================================

  - wait:
      text: 'Software License'
      timeout: 30

  - delay: 1

  # Confirm agreement
  - key: tab
  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 11: Create Computer Account
  # ============================================

  # This is the most timing-sensitive part - if the VM is too slow,
  # account creation can fail.

  - wait:
      text: 'Create a Computer Account'
      timeout: 120

  - delay: 3

  # Fill in account details:
  # Full Name field
  - type: 'admin'
  - delay: 1
  - key: tab
  - delay: 1

  # Account Name (auto-filled, but we type it anyway)
  - type: 'admin'
  - delay: 1
  - key: tab
  - delay: 1

  # Password
  - type: 'admin'
  - delay: 1
  - key: tab
  - delay: 1

  # Verify Password
  - type: 'admin'
  - delay: 1
  - key: tab
  - delay: 1

  # Skip Hint field
  - key: tab
  - delay: 1

  # Continue button
  - key: space
  - delay: 5

  # ============================================
  # Stage 12: Enable Location Services
  # ============================================

  - wait:
      text: 'Enable Location Services'
      timeout: 120

  - delay: 1

  # Decline location services
  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 2

  # ============================================
  # Stage 13: Location Services Confirmation
  # ============================================

  - wait:
      text: 'Are you sure you don'
      timeout: 30

  - delay: 1

  # Confirm skipping location services
  - key: tab
  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 14: Select Time Zone
  # ============================================

  - wait:
      text: 'Select Your Time Zone'
      timeout: 60

  - delay: 1

  # Navigate to search field and set UTC
  - key: tab
  - delay: 1
  - type: 'UTC'
  - delay: 1
  - key: enter
  - delay: 1

  # Continue
  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 15: Analytics
  # ============================================

  - wait:
      text: 'Analytics'
      timeout: 60

  - delay: 1

  # Uncheck analytics sharing and continue
  - key: tab
  - delay: 1
  - key: space
  - delay: 1

  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 16: Screen Time
  # ============================================

  # Screen Time can have a delay while checking iCloud status
  - wait:
      text: 'Screen Time'
      timeout: 120

  - delay: 5

  # Skip Screen Time setup
  - key: tab
  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 17: Choose Your Look (Light/Dark Mode)
  # ============================================

  - wait:
      text: 'Choose Your Look'
      timeout: 60

  - delay: 1

  # Accept default and continue
  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 5

  # ============================================
  # Stage 18: Desktop Setup Complete - Enable SSH
  # ============================================

  # Wait for Finder to appear (indicates desktop is ready)
  - wait:
      text: 'Finder'
      timeout: 180

  - delay: 5

  # Click on Spotlight area (menu bar) to ensure keyboard focus
  - click_at:
      x: 400
      y: 1035

  - delay: 2

  # Wait for App Store to appear in Spotlight results area
  - wait:
      text: 'App Store'
      timeout: 30

  - delay: 1

  # Type "terminal" to search
  - type: 'terminal'
  - delay: 2

  # Wait for Terminal to appear in search results
  - wait:
      text: 'Terminal'
      timeout: 30

  - delay: 1

  # Launch Terminal
  - key: enter
  - delay: 5

  # Wait for Terminal window
  - wait:
      text: '80x24'
      timeout: 30

  - delay: 2

  # ============================================
  # Stage 19: Enable SSH (Remote Login)
  # ============================================

  # Enable Remote Login using launchctl
  - type: 'sudo sh -ec "launchctl load -w /System/Library/LaunchDaemons/ssh.plist; while ! ssh-keyscan 127.0.0.1; do echo SSH Not Ready; done"'
  - key: enter
  - delay: 2

  # Enter password when prompted
  - wait:
      text: 'Password'
      timeout: 30

  - delay: 1
  - type: 'admin'
  - key: enter
  - delay: 5

  # ============================================
  # Setup Complete!
  # ============================================
  # The VM is now configured with:
  # - User account: admin / admin
  # - SSH enabled on port 22
  # - Time zone: UTC
  # - No iCloud/Apple ID configured
  # - Analytics disabled

  - delay: 10

# Health check to verify setup was successful
# This will SSH into the VM to confirm SSH is working
# Note: The port here is the guest port (22). Configure port forwarding
# in your VM builder (e.g., sshPort parameter in makeDarwinVM).
health_check:
  type: ssh
  host: 127.0.0.1
  port: 22
  user: admin
  password: admin
  timeout: 30
  retries: 10
  retry_delay: 15
  command: 'sw_vers'
