# Copyright 2026 Schelling Point Labs Inc
# SPDX-License-Identifier: AGPL-3.0-only

# Unattended macOS Tahoe Setup Assistant Configuration
#
# This YAML config automates the macOS Tahoe (16.x) OOBE setup for creating
# reproducible VM images. Uses native YAML format for validation and IDE support.
#
# Usage:
#   yaml-automation-runner --config macos-tahoe.yml --vnc localhost:5903
#
# Prerequisites:
#   - macOS Tahoe BaseSystem.img (from fetchMacOSBaseSystem)
#   - OpenCore bootloader configured
#   - InstallAssistant.pkg ISO mounted
#   - run_offline.sh ISO mounted at /Volumes/run_offline/
#
# Account credentials created:
#   - Username: admin
#   - Password: admin
#
# Key differences from Sequoia:
#   - Migration Assistant: Tab navigation (3 tabs to "Set up as new")
#   - Account Creation: Avatar picker (6 tabs before Full Name field)
#   - FileVault encryption screen (NEW - after Siri)
#   - Welcome screen: "Get Started" button
#
# References:
#   - Sequoia config: macos-sequoia.yml
#   - Lume Tahoe: https://github.com/trycua/cua/blob/main/libs/lume/src/Resources/unattended-presets/tahoe.yml
#   - Schema: YAML-AUTOMATION-SCHEMA.md

# Seconds to wait after VM boots before starting automation
# Tahoe boots at similar speed to Sequoia
boot_wait: 30

boot_commands:
  # ============================================
  # Stage 1: Initial Boot and Installer Setup
  # ============================================

  # Wait for the installer to reach the "Continue" button
  # This appears after the language selection animation completes
  - wait:
      text: 'Continue'
      timeout: 300

  - delay: 5

  # Open Terminal using keyboard shortcut (Shift+Cmd+T in Recovery)
  # This is needed to run the offline installation script
  - hotkey:
      modifiers: [shift, cmd]
      key: t

  - delay: 3

  # Wait for Terminal to open
  - wait:
      text: 'Terminal'
      timeout: 30

  - wait:
      text: '80x24'
      timeout: 10

  - delay: 2

  # Run the offline installation script that partitions the disk
  # This script is provided on the run_offline ISO mounted at /Volumes/run_offline/
  - type: 'sh /Volumes/run_offline/run_offline.sh'
  - key: enter
  - delay: 10

  # ============================================
  # Stage 2: Country/Region Selection
  # ============================================

  - wait:
      text: 'Select Your Country or Region'
      timeout: 120

  - delay: 2

  # Type to filter and select United States
  - type: 'united states'
  - delay: 1

  # Navigate to Continue button (Shift+Tab moves backwards through UI)
  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 3: Written and Spoken Languages
  # ============================================

  - wait:
      text: 'Written and Spoken Languages'
      timeout: 60

  - delay: 1

  # Skip customization, go directly to Continue
  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 4: Accessibility
  # ============================================

  - wait:
      text: 'Accessibility'
      timeout: 60

  - delay: 1

  # Skip accessibility setup
  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 5: Network Connection (Offline Mode)
  # ============================================

  - wait:
      text: 'How Do You Connect'
      timeout: 60

  - delay: 2

  # Click on "My computer does not connect to the internet" option
  # Coordinates based on NixThePlanet's working values for 1920x1080
  - click_at:
      x: 815
      y: 480

  - delay: 10

  # Click Continue button
  - click_at:
      x: 1330
      y: 820

  - delay: 3

  # ============================================
  # Stage 6: No Internet Confirmation
  # ============================================

  - wait:
      text: 'Your Mac isn'
      timeout: 30

  - delay: 2

  # Click Continue to proceed without internet
  - click_at:
      x: 1020
      y: 640

  - delay: 3

  # ============================================
  # Stage 7: Data & Privacy
  # ============================================

  - wait:
      text: 'Data & Privacy'
      timeout: 60

  - delay: 1

  # Continue past privacy notice
  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 8: Migration Assistant (CHANGED in Tahoe)
  # ============================================

  # Tahoe uses different tab navigation - 3 tabs to "Set up as new"
  - wait:
      text: 'Transfer Your Data'
      timeout: 60

  - delay: 20

  # Tab order: From a Mac -> From Windows PC -> Set up with iPhone -> Set up as new
  # We need 3 tabs to reach the 4th option "Set up as new"
  - key: tab
  - delay: 2
  - key: tab
  - delay: 2
  - key: tab
  - delay: 2
  - key: space
  - delay: 1

  # Click Continue
  - click: 'Continue'
  - delay: 3

  # ============================================
  # Stage 9: Terms and Conditions
  # ============================================

  - wait:
      text: 'Terms and Conditions'
      timeout: 60

  - delay: 1

  # Navigate to Agree button
  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 2

  # ============================================
  # Stage 10: License Agreement Confirmation
  # ============================================

  - wait:
      text: 'Software License'
      timeout: 30

  - delay: 1

  # Confirm agreement
  - key: tab
  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 11: Create Computer Account (CHANGED in Tahoe)
  # ============================================

  # Tahoe has avatar picker - need 6 tabs to skip past it
  # Field order: Avatar picker (6 icons) -> Full Name -> Account Name -> Password -> Verify Password -> Hint -> Continue

  - wait:
      text: 'Create a Mac Account'
      timeout: 120

  - delay: 3

  # Tab past avatar picker icons (6 tabs)
  - key: tab
  - delay: 1
  - key: tab
  - delay: 1
  - key: tab
  - delay: 1
  - key: tab
  - delay: 1
  - key: tab
  - delay: 1
  - key: tab
  - delay: 1

  # Now at Full Name field
  - type: 'admin'
  - delay: 1
  - key: tab
  - delay: 1

  # Account Name (auto-filled, but we type it anyway)
  - type: 'admin'
  - delay: 1
  - key: tab
  - delay: 1

  # Password
  - type: 'admin'
  - delay: 1
  - key: tab
  - delay: 1

  # Verify Password
  - type: 'admin'
  - delay: 1
  - key: tab
  - delay: 1

  # Skip Hint field
  - key: tab
  - delay: 1

  # Continue button
  - key: space
  - delay: 5

  # ============================================
  # Stage 12: Apple Account Sign-In
  # ============================================

  # Similar to Sequoia - has confirmation popup
  - wait:
      text: 'Sign In with Your Apple'
      timeout: 60

  - delay: 2

  # Click "Set Up Later" to skip
  - click: 'Set Up Later'
  - delay: 2

  # Confirmation popup "Are you sure you want to skip?"
  - wait:
      text: "Don't Skip"
      timeout: 30

  - delay: 1

  # Tab to "Skip" button and press enter
  - key: tab
  - delay: 1
  - key: enter
  - delay: 3

  # ============================================
  # Stage 13: Enable Location Services
  # ============================================

  - wait:
      text: 'Enable Location Services'
      timeout: 120

  - delay: 1

  # Decline location services
  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 2

  # ============================================
  # Stage 14: Location Services Confirmation
  # ============================================

  - wait:
      text: 'Are you sure you don'
      timeout: 30

  - delay: 1

  # Confirm skipping location services
  - key: tab
  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 15: Select Time Zone
  # ============================================

  - wait:
      text: 'Select Your Time Zone'
      timeout: 60

  - delay: 1

  # Navigate to search field and set UTC
  - key: tab
  - delay: 1
  - type: 'UTC'
  - delay: 1
  - key: enter
  - delay: 1

  # Continue
  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 16: Analytics
  # ============================================

  - wait:
      text: 'Analytics'
      timeout: 60

  - delay: 1

  # Uncheck analytics sharing and continue
  - key: tab
  - delay: 1
  - key: space
  - delay: 1

  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 17: Screen Time
  # ============================================

  # Screen Time can have a longer delay while checking iCloud status
  - wait:
      text: 'Screen Time'
      timeout: 300

  - delay: 5

  # Skip Screen Time setup
  - key: tab
  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 18: Siri Setup (2 screens)
  # ============================================

  # Screen 1: Enable Siri
  - wait:
      text: 'Siri'
      timeout: 300

  - delay: 1

  # Continue to enable Siri
  - click: 'Continue'
  - delay: 3

  # Screen 2: Select a Siri Voice
  - wait:
      text: 'Select a Siri Voice'
      timeout: 60

  - delay: 1

  # Choose default voice
  - click: 'Choose For Me'
  - delay: 3

  # Screen 3: Improve Siri & Dictation
  - wait:
      text: 'Improve Siri'
      timeout: 60

  - delay: 1

  # Decline sharing Siri data
  - click: 'Not Now'
  - delay: 1
  - click: 'Continue'
  - delay: 3

  # ============================================
  # Stage 19: FileVault (NEW in Tahoe)
  # ============================================

  # Tahoe adds FileVault encryption setup screen
  - wait:
      text: 'FileVault'
      timeout: 60

  - delay: 1

  # Skip FileVault encryption
  - click: 'Not Now'
  - delay: 1

  # Confirmation popup: "Mac Data Will Not Be Securely Encrypted"
  - wait:
      text: 'Securely Encrypted'
      timeout: 30

  - delay: 1
  - click: 'Continue'
  - delay: 3

  # ============================================
  # Stage 20: Choose Your Look (Light/Dark Mode)
  # ============================================

  - wait:
      text: 'Choose Your Look'
      timeout: 60

  - delay: 1

  # Accept default and continue
  - hotkey:
      modifiers: [shift]
      key: tab

  - delay: 1
  - key: space
  - delay: 3

  # ============================================
  # Stage 21: Update Mac Automatically
  # ============================================

  - wait:
      text: 'Update Mac Automatically'
      timeout: 60

  - delay: 1

  # Continue with default settings
  - click: 'Continue'
  - delay: 5

  # ============================================
  # Stage 22: Desktop Setup Complete - Enable SSH
  # ============================================

  # Wait for Finder to appear (indicates desktop is ready)
  - wait:
      text: 'Finder'
      timeout: 180

  - delay: 5

  # Click on Spotlight area (menu bar) to ensure keyboard focus
  - click_at:
      x: 400
      y: 1035

  - delay: 2

  # Wait for App Store to appear in Spotlight results area
  - wait:
      text: 'App Store'
      timeout: 30

  - delay: 1

  # Type "terminal" to search
  - type: 'terminal'
  - delay: 2

  # Wait for Terminal to appear in search results
  - wait:
      text: 'Terminal'
      timeout: 30

  - delay: 1

  # Launch Terminal
  - key: enter
  - delay: 5

  # Wait for Terminal window
  - wait:
      text: '80x24'
      timeout: 30

  - delay: 2

  # ============================================
  # Stage 23: Enable SSH (Remote Login)
  # ============================================

  # Enable Remote Login using launchctl
  - type: 'sudo sh -ec "launchctl load -w /System/Library/LaunchDaemons/ssh.plist; while ! ssh-keyscan 127.0.0.1; do echo SSH Not Ready; done"'
  - key: enter
  - delay: 2

  # Enter password when prompted
  - wait:
      text: 'Password'
      timeout: 30

  - delay: 1
  - type: 'admin'
  - key: enter
  - delay: 5

  # ============================================
  # Setup Complete!
  # ============================================
  # The VM is now configured with:
  # - User account: admin / admin
  # - SSH enabled on port 22
  # - Time zone: UTC
  # - Siri enabled with default voice
  # - Auto-updates enabled (default)
  # - No iCloud/Apple ID configured
  # - No FileVault encryption
  # - Analytics disabled

  - delay: 10

# Health check to verify setup was successful
# This will SSH into the VM to confirm SSH is working
# Note: The port here is the guest port (22). Configure port forwarding
# in your VM builder (e.g., sshPort parameter in makeDarwinVM).
health_check:
  type: ssh
  host: 127.0.0.1
  port: 22
  user: admin
  password: admin
  timeout: 30
  retries: 10
  retry_delay: 15
  command: 'sw_vers'
